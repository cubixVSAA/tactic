<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pizarra Táctica Digital Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TacticsPro">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600;800&display=swap" rel="stylesheet">
    
    <!-- Iconos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- PWA Loader Script -->
    <script>
        (function() {
            // Icono SVG Vectorizado del Logotipo (3 figuras)
            const iconSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <rect width="512" height="512" rx="100" fill="#0f172a"/>
                <!-- Cabezas -->
                <circle cx="256" cy="100" r="45" fill="#3b82f6"/>
                <circle cx="130" cy="180" r="45" fill="#3b82f6"/>
                <circle cx="382" cy="180" r="45" fill="#3b82f6"/>
                <!-- Cuerpo / Flecha -->
                <path d="M256 160 L400 300 V420 H340 V320 L256 240 L172 320 V420 H112 V300 Z" fill="#3b82f6"/>
            </svg>`;
            
            const iconUrl = "data:image/svg+xml;base64," + btoa(iconSvg);

            const manifest = {
                "name": "Pizarra Táctica Pro",
                "short_name": "TacticsPro",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#0f172a",
                "theme_color": "#0f172a",
                "orientation": "any",
                "icons": [
                    { "src": iconUrl, "sizes": "192x192", "type": "image/svg+xml" },
                    { "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml" }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);

            const appleIcon = document.createElement('link');
            appleIcon.rel = 'apple-touch-icon';
            appleIcon.href = iconUrl;
            document.head.appendChild(appleIcon);

            // NOTA: Se ha eliminado el registro del Service Worker para evitar errores 
            // de protocolo 'blob:' en entornos sandboxed/iframe.
        })();
    </script>

    <style>
        body {
            font-family: 'Barlow', sans-serif;
            overflow: hidden; 
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            /* Prevención de pull-to-refresh en móvil */
            overscroll-behavior: none;
        }

        .bg-tech-pattern {
            background-color: #0f172a;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .field-container {
            perspective: 1000px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), width 0.5s, height 0.5s;
            transform-origin: center center;
            position: absolute; 
        }

        .player-token {
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.2s, left 0.1s, top 0.1s;
            user-select: none;
            touch-action: none;
            z-index: 50;
            transform: translate(-50%, -50%);
        }

        .field-container.rotated-view .player-token {
            transform: translate(-50%, -50%) rotate(90deg);
        }

        .player-token.is-dragging {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.3) !important;
            z-index: 100;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .field-container.rotated-view .player-token.is-dragging {
            transform: translate(-50%, -50%) rotate(90deg) scale(1.3) !important;
        }

        svg { transition: viewBox 0.5s ease; }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.3s forwards; }

        /* Modal de Instrucciones iOS */
        #ios-install-modal {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #334155;
            padding: 20px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .bounce-arrow { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
    </style>
</head>
<body class="bg-tech-pattern text-slate-200 h-screen w-screen flex flex-col">

    <!-- Header -->
    <!-- MODIFICADO: Quitamos altura fija y flex directo del header. Añadimos padding-top dinámico para "Safe Area" (Notch) -->
    <header class="bg-slate-900 border-b border-slate-700 shadow-lg z-50 shrink-0 pt-[env(safe-area-inset-top)]">
        
        <!-- Nuevo contenedor interno que mantiene la altura de 16 (64px) y la distribución Flex -->
        <div class="h-16 flex items-center justify-between px-2 md:px-6 gap-2 md:gap-4 w-full">
            
            <!-- Izquierda: Selectores de Deporte y Vista (Reordenados) -->
            <div class="flex items-center gap-2 md:gap-4 overflow-x-auto no-scrollbar">
                
                <!-- 1. Selector Deporte (Ahora primero) -->
                <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700 shrink-0">
                     <button onclick="setSport('futsal')" id="btn-sport-futsal" class="px-3 py-1 rounded text-xs md:text-sm font-semibold transition-all flex items-center justify-center gap-2 bg-blue-600 text-white shadow" title="Fútbol Sala">
                        <i class="fa-solid fa-futbol"></i>
                        <span class="hidden md:inline">Futsal</span>
                    </button>
                    <button onclick="setSport('basketball')" id="btn-sport-basket" class="px-3 py-1 rounded text-xs md:text-sm font-semibold transition-all flex items-center justify-center gap-2 text-slate-500 hover:text-amber-500" title="Baloncesto">
                        <i class="fa-solid fa-basketball"></i>
                        <span class="hidden md:inline">Basket</span>
                    </button>
                </div>

                <!-- Separador -->
                <div class="h-8 w-px bg-slate-700 mx-1 hidden sm:block"></div>

                <!-- 2. Selector Vista (Ahora segundo) -->
                <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700 shrink-0">
                    <button onclick="setViewMode('full')" id="btn-view-full" class="px-4 py-1 rounded text-xs md:text-sm font-semibold transition-all bg-slate-700 text-white shadow-sm" title="Campo Completo">
                        <i class="fa-solid fa-expand md:mr-1"></i> <span class="hidden md:inline">Completo</span>
                    </button>
                    <button onclick="setViewMode('half')" id="btn-view-half" class="px-4 py-1 rounded text-xs md:text-sm font-semibold transition-all text-slate-400 hover:text-white" title="Media Cancha (Auto)">
                        <i class="fa-solid fa-arrows-up-down md:mr-1"></i> <span class="hidden md:inline">Media</span>
                    </button>
                </div>
                
            </div>

            <div class="flex items-center gap-2 bg-slate-800/50 px-3 py-1.5 rounded-full border border-slate-700 shadow-inner shrink-0">
                <div class="generator-token w-8 h-8 rounded-full bg-blue-600 border-2 border-white shadow-lg flex items-center justify-center font-bold text-white text-sm"
                     draggable="true" ondragstart="handleDragStart(event, 'A', 'auto')" onclick="addPlayerClick('A', 'auto')">
                    <i class="fa-solid fa-plus text-[10px]"></i>
                </div>
                 <div class="generator-token w-7 h-7 rounded-full bg-amber-400 border border-slate-800 shadow-lg flex items-center justify-center text-slate-900"
                     draggable="true" ondragstart="handleDragStart(event, 'Ball', '')" onclick="addPlayerClick('Ball', '')">
                     <i class="fa-solid fa-futbol text-xs"></i>
                 </div>
                <div class="generator-token w-8 h-8 rounded-full bg-red-600 border-2 border-white shadow-lg flex items-center justify-center font-bold text-white text-sm"
                     draggable="true" ondragstart="handleDragStart(event, 'B', 'auto')" onclick="addPlayerClick('B', 'auto')">
                    <i class="fa-solid fa-plus text-[10px]"></i>
                </div>
            </div>

            <div class="flex gap-2">
                <!-- BOTÓN INSTALAR PWA (Solo visible si no está instalada) -->
                <button id="btn-install-pwa" onclick="promptInstall()" class="hidden w-8 h-8 bg-indigo-600 hover:bg-indigo-500 text-white rounded flex items-center justify-center shadow transition-colors animate-pulse" title="Instalar App">
                    <i class="fa-solid fa-download"></i>
                </button>

                <button onclick="saveTactic()" class="w-8 h-8 bg-emerald-600 hover:bg-emerald-500 text-white rounded flex items-center justify-center shadow transition-colors" title="Guardar">
                    <i class="fa-solid fa-floppy-disk"></i>
                </button>
                <button onclick="loadTactic()" class="w-8 h-8 bg-slate-700 hover:bg-slate-600 text-white rounded flex items-center justify-center shadow transition-colors" title="Cargar">
                    <i class="fa-solid fa-cloud-arrow-down"></i>
                </button>
                <button onclick="clearField()" class="w-8 h-8 bg-red-900/80 hover:bg-red-800 text-white rounded flex items-center justify-center shadow transition-colors" title="Limpiar">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </div>
        
        </div> <!-- Fin contenedor interno -->
    </header>

    <!-- Área Principal -->
    <main class="flex-1 relative overflow-hidden flex flex-col items-center justify-center bg-slate-900/50">
        
        <div id="canvas-area" class="w-full h-full p-0 md:p-2 flex items-center justify-center relative overflow-hidden">
            <div id="field-container" class="field-container bg-slate-800 rounded shadow-2xl border-4 border-slate-700 select-none overflow-hidden">
                
                <!-- SVG Futsal -->
                <svg id="field-futsal" class="w-full h-full absolute inset-0 transition-all duration-500" viewBox="0 0 800 500" preserveAspectRatio="none">
                    <rect width="800" height="500" fill="#3b82f6" fill-opacity="0.1"/>
                    <g stroke="white" stroke-width="3" fill="none" opacity="0.8">
                        <rect x="25" y="25" width="750" height="450" />
                        <line x1="400" y1="25" x2="400" y2="475" />
                        <circle cx="400" cy="250" r="50" />
                        <path d="M 25 150 Q 100 150 100 250 Q 100 350 25 350" />
                        <path d="M 775 150 Q 700 150 700 250 Q 700 350 775 350" />
                        <circle cx="100" cy="250" r="3" fill="white" stroke="none"/>
                        <circle cx="700" cy="250" r="3" fill="white" stroke="none"/>
                    </g>
                </svg>

                <!-- SVG Basket -->
                <svg id="field-basketball" class="w-full h-full absolute inset-0 hidden transition-all duration-500" viewBox="0 0 800 500" preserveAspectRatio="none">
                    <rect width="800" height="500" fill="#d97706" fill-opacity="0.15"/>
                    <defs>
                         <pattern id="woodPattern" width="20" height="20" patternUnits="userSpaceOnUse">
                             <path d="M0 10 L20 10" stroke="#b45309" stroke-width="0.5" opacity="0.3"/>
                         </pattern>
                    </defs>
                    <rect width="800" height="500" fill="url(#woodPattern)"/>
                    <g stroke="white" stroke-width="3" fill="none" opacity="0.9">
                        <rect x="25" y="25" width="750" height="450" />
                        <line x1="400" y1="25" x2="400" y2="475" />
                        <circle cx="400" cy="250" r="50" />
                        <rect x="25" y="190" width="120" height="120" />
                        <circle cx="145" cy="250" r="40" stroke-dasharray="5,5" />
                        <path d="M 25 60 L 120 60 Q 250 250 120 440 L 25 440" />
                        <rect x="655" y="190" width="120" height="120" />
                        <circle cx="655" cy="250" r="40" stroke-dasharray="5,5" />
                        <path d="M 775 60 L 680 60 Q 550 250 680 440 L 775 440" />
                    </g>
                </svg>

                <!-- Capa Jugadores -->
                <div id="players-layer" class="absolute inset-0 z-10 transition-all duration-500 origin-left"></div>
            </div>
        </div>

    </main>
    
    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-slate-600 text-white px-6 py-3 rounded-lg shadow-2xl transition-all duration-300 -translate-y-40 opacity-0 z-50 flex items-center gap-3 pointer-events-none">
        <i class="fa-solid fa-circle-check text-emerald-400"></i>
        <span id="toast-msg">Notificación</span>
    </div>

    <!-- Modal Instrucciones iOS -->
    <div id="ios-install-modal">
        <div class="flex flex-col items-center text-center space-y-4 text-white">
            <div class="flex justify-between w-full items-center">
                <h3 class="font-bold text-lg">Instalar App</h3>
                <button onclick="document.getElementById('ios-install-modal').style.display='none'" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <p class="text-sm text-slate-300">Para instalar en tu iPhone/iPad:</p>
            <div class="flex items-center gap-2 text-sm">
                <span>1. Toca</span>
                <i class="fa-solid fa-arrow-up-from-bracket text-blue-400 text-lg"></i>
                <span><b>Compartir</b> abajo</span>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <span>2. Selecciona</span>
                <span class="bg-slate-700 px-2 py-1 rounded border border-slate-500 flex items-center gap-1"><i class="fa-regular fa-square-plus"></i> Añadir a inicio</span>
            </div>
            <i class="fa-solid fa-arrow-down text-blue-500 text-2xl bounce-arrow mt-2"></i>
        </div>
    </div>

    <script>
        // --- PWA Logic (Prompt & Install) ---
        let deferredPrompt;
        const installBtn = document.getElementById('btn-install-pwa');
        const iosModal = document.getElementById('ios-install-modal');

        // Detectar si ya está instalada (Standalone)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        
        // Detectar iOS
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        if (!isStandalone) {
            // Mostrar botón instalar
            installBtn.classList.remove('hidden');
        }

        // Android / Desktop Chrome
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.classList.remove('hidden');
        });

        function promptInstall() {
            if (isIos) {
                // Mostrar instrucciones iOS
                iosModal.style.display = 'block';
            } else if (deferredPrompt) {
                // Prompt Nativo Android
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        installBtn.classList.add('hidden');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert("Para instalar, busca la opción 'Añadir a pantalla de inicio' en el menú de tu navegador.");
            }
        }

        // --- Estado App ---
        const state = {
            sport: 'futsal',
            viewMode: 'full', 
            activeHalf: 'left', // 'left' o 'right'
            isVertical: false, // Detecta si el campo debe renderizarse verticalmente
            players: [],
            nextId: 1
        };

        const canvasArea = document.getElementById('canvas-area');
        const fieldContainer = document.getElementById('field-container');
        const playersLayer = document.getElementById('players-layer');

        const FULL_WIDTH = 800;
        const HALF_VIEW_WIDTH = 460; 
        const SCALE_RATIO = FULL_WIDTH / HALF_VIEW_WIDTH;
        const FIELD_RATIO = 1.6;

        let dribbleState = null;

        function init() {
            fieldContainer.addEventListener('dragover', (e) => e.preventDefault());
            fieldContainer.addEventListener('drop', handleDropFromToolbar);
            fieldContainer.addEventListener('contextmenu', (e) => e.preventDefault());
            
            window.addEventListener('resize', () => {
                clearTimeout(window.resizeTimer);
                window.resizeTimer = setTimeout(updateFieldZoom, 100);
            });

            setTimeout(updateFieldZoom, 50);
            renderPlayers();
            
            // Mensaje inicial diferente si es PWA o Web
            if (isStandalone) {
                showToast('Modo App Activo');
            }
        }

        // --- Vista Dinámica ---
        function setViewMode(mode) {
            state.viewMode = mode;
            
            if (mode === 'half') {
                detectActiveHalf();
            } else {
                state.activeHalf = 'left'; 
            }
            
            const btnFull = document.getElementById('btn-view-full');
            const btnHalf = document.getElementById('btn-view-half');
            
            if (mode === 'full') {
                btnFull.className = 'px-4 py-1 rounded text-xs md:text-sm font-semibold transition-all bg-slate-700 text-white shadow-sm';
                btnHalf.className = 'px-4 py-1 rounded text-xs md:text-sm font-semibold transition-all text-slate-400 hover:text-white';
            } else {
                btnFull.className = 'px-4 py-1 rounded text-xs md:text-sm font-semibold transition-all text-slate-400 hover:text-white';
                btnHalf.className = 'px-4 py-1 rounded text-xs md:text-sm font-semibold transition-all bg-slate-700 text-white shadow-sm';
                showToast(state.activeHalf === 'right' ? 'Lado Derecho' : 'Lado Izquierdo');
            }

            updateFieldZoom();
            renderPlayers();
        }

        function detectActiveHalf() {
            if (state.players.length === 0) {
                state.activeHalf = 'left';
                return;
            }
            let sumX = 0;
            let count = 0;
            state.players.forEach(p => {
                sumX += p.x;
                count++;
            });
            const avgX = sumX / count;
            state.activeHalf = avgX > 50 ? 'right' : 'left';
        }

        function updatePlayerRotationClasses() {
            const tokens = document.querySelectorAll('.player-token');
            tokens.forEach(el => {
                // NO TOCAR DOM, SOLO CLASES. El CSS maneja la rotación.
            });
        }

        function updateFieldZoom() {
            const svgs = ['field-futsal', 'field-basketball'];
            
            let viewBox;
            if (state.viewMode === 'full') {
                viewBox = `0 0 ${FULL_WIDTH} 500`;
            } else {
                if (state.activeHalf === 'right') {
                    const startX = FULL_WIDTH - HALF_VIEW_WIDTH; 
                    viewBox = `${startX} 0 ${HALF_VIEW_WIDTH} 500`;
                } else {
                    viewBox = `0 0 ${HALF_VIEW_WIDTH} 500`;
                }
            }
            
            svgs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.setAttribute('viewBox', viewBox);
            });

            const availW = canvasArea.clientWidth - (state.viewMode === 'full' ? 16 : 8); 
            const availH = canvasArea.clientHeight - (state.viewMode === 'full' ? 16 : 8);

            state.isVertical = state.viewMode === 'half' || (availH > availW);

            let targetW, targetH, rotation;

            if (state.isVertical) {
                // Vertical Logic
                let logicalW = 500;
                let logicalH = state.viewMode === 'half' ? HALF_VIEW_WIDTH : FULL_WIDTH;
                
                const visualRatio = logicalW / logicalH; 
                const screenRatio = availW / availH;

                let renderW, renderH; 
                
                if (screenRatio > visualRatio) {
                    renderH = availH;
                    renderW = renderH * visualRatio;
                } else {
                    renderW = availW;
                    renderH = renderW / visualRatio;
                }
                
                targetW = renderH; 
                targetH = renderW;
                rotation = 'rotate(-90deg)';
                
                fieldContainer.classList.add('rotated-view');
                
                if (state.viewMode === 'half') {
                    const scalePercent = (FULL_WIDTH / HALF_VIEW_WIDTH) * 100;
                    playersLayer.style.width = `${scalePercent}%`;
                } else {
                    playersLayer.style.width = '100%';
                }
                playersLayer.style.height = '100%';

            } else {
                // Horizontal Logic
                const visualRatio = FULL_WIDTH / 500;
                const screenRatio = availW / availH;

                if (screenRatio > visualRatio) {
                    targetH = availH;
                    targetW = targetH * visualRatio;
                } else {
                    targetW = availW;
                    targetH = targetW / visualRatio;
                }
                rotation = 'none';
                
                fieldContainer.classList.remove('rotated-view');
                
                playersLayer.style.width = '100%';
                playersLayer.style.height = '100%';
            }

            fieldContainer.style.width = `${targetW}px`;
            fieldContainer.style.height = `${targetH}px`;
            fieldContainer.style.transform = rotation;
        }

        function setSport(sportName) {
            state.sport = sportName;
            const btnFutsal = document.getElementById('btn-sport-futsal');
            const btnBasket = document.getElementById('btn-sport-basket');
            
            btnFutsal.className = sportName === 'futsal' 
                ? 'px-3 py-1 rounded text-xs md:text-sm font-semibold transition-all flex items-center justify-center gap-2 bg-blue-600 text-white shadow' 
                : 'px-3 py-1 rounded text-xs md:text-sm font-semibold transition-all flex items-center justify-center gap-2 text-slate-500 hover:text-blue-400';
            
            btnBasket.className = sportName === 'basketball' 
                ? 'px-3 py-1 rounded text-xs md:text-sm font-semibold transition-all flex items-center justify-center gap-2 bg-amber-600 text-white shadow' 
                : 'px-3 py-1 rounded text-xs md:text-sm font-semibold transition-all flex items-center justify-center gap-2 text-slate-500 hover:text-amber-500';

            document.getElementById('field-futsal').classList.toggle('hidden', sportName !== 'futsal');
            document.getElementById('field-basketball').classList.toggle('hidden', sportName !== 'basketball');
            fieldContainer.style.backgroundColor = sportName === 'futsal' ? '#1e3a8a' : '#78350f';
        }

        function getNextPlayerNumber(teamType) {
            const usedNumbers = state.players
                .filter(p => p.type === teamType)
                .map(p => typeof p.number === 'string' ? parseInt(p.number) : p.number)
                .filter(n => !isNaN(n));
            let i = 1;
            while (true) {
                if (!usedNumbers.includes(i)) return i;
                i++;
            }
        }

        function createPlayer(type, number, xPercent, yPercent) {
            let finalNumber = number;
            if (number === 'auto') finalNumber = getNextPlayerNumber(type);

            const player = {
                id: state.nextId++,
                type: type,
                number: finalNumber,
                x: xPercent,
                y: yPercent
            };
            state.players.push(player);
            renderOnePlayer(player);
        }

        function addPlayerClick(type, number) {
            let centerX = 50;
            if (state.viewMode === 'half') {
                centerX = state.activeHalf === 'right' ? 71.25 : 28.75;
            }
            const rand = () => (Math.random() * 6) - 3;
            createPlayer(type, number, centerX + rand(), 50 + rand());
        }

        function updateDOMPosition(id, logicalX, logicalY) {
            const el = document.getElementById(`player-${id}`);
            if (!el) return;

            let cssLeft = logicalX;
            if (state.viewMode === 'half') {
                if (state.activeHalf === 'right') {
                    const logicalUnits = (logicalX / 100) * FULL_WIDTH; 
                    const visualPct = ((logicalUnits - (FULL_WIDTH - HALF_VIEW_WIDTH)) / HALF_VIEW_WIDTH) * 100;
                    cssLeft = visualPct;
                } else {
                    cssLeft = logicalX * SCALE_RATIO;
                }
            }
            el.style.left = `${cssLeft}%`;
            el.style.top = `${logicalY}%`;
        }

        function renderOnePlayer(player) {
            let el = document.getElementById(`player-${player.id}`);
            if (!el) {
                el = document.createElement('div');
                el.id = `player-${player.id}`;
                el.className = `player-token absolute w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center font-bold text-white shadow-md border-2 border-white select-none animate-pop text-base md:text-lg`;
                
                if (player.type === 'A') el.classList.add('bg-blue-600');
                else if (player.type === 'B') el.classList.add('bg-red-600');
                else {
                    el.className = `player-token absolute w-6 h-6 md:w-7 md:h-7 rounded-full flex items-center justify-center bg-amber-400 border border-slate-800 shadow-sm animate-pop`;
                    el.innerHTML = '<i class="fa-solid fa-futbol text-slate-900 text-xs"></i>';
                }

                if (player.type !== 'Ball') el.innerText = player.number;
                
                el.addEventListener('mousedown', (e) => startMoving(e, player.id, false));
                el.addEventListener('touchstart', (e) => startMoving(e, player.id, true), {passive: false});
                
                playersLayer.appendChild(el);
            }
            updateDOMPosition(player.id, player.x, player.y);
        }

        function renderPlayers() {
            playersLayer.innerHTML = '';
            state.players.forEach(renderOnePlayer);
        }

        function removePlayer(id) {
            state.players = state.players.filter(p => p.id !== id);
            const el = document.getElementById(`player-${id}`);
            if (el) {
                el.style.transition = "transform 0.2s, opacity 0.2s";
                el.style.transform = "translate(-50%, -50%) scale(0)";
                el.style.opacity = "0";
                setTimeout(() => el.remove(), 200);
            }
        }

        function clearField() {
            if(confirm("¿Limpiar pizarra?")) {
                state.players = [];
                renderPlayers();
            }
        }

        let activePlayerId = null;
        let isTouch = false;

        function handleDragStart(e, type, number) {
            e.dataTransfer.setData('text/plain', JSON.stringify({ type, number }));
        }

        function handleDropFromToolbar(e) {
            e.preventDefault();
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                const rect = fieldContainer.getBoundingClientRect(); 
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                const coords = calculateCoordinates(x, y, rect.width, rect.height);
                createPlayer(data.type, data.number, coords.x, coords.y);
            } catch (err) {}
        }

        function startMoving(e, id, touchMode) {
            if (!touchMode && e.button !== 0) return;
            e.stopPropagation();

            activePlayerId = id;
            isTouch = touchMode;
            
            const el = document.getElementById(`player-${id}`);
            if(el) el.classList.add('is-dragging');

            // --- LOGICA DE DRIBBLING DINÁMICO ---
            dribbleState = null;
            const player = state.players.find(p => p.id === id);
            if (player && player.type !== 'Ball') { 
                const ball = state.players.find(p => p.type === 'Ball');
                if (ball) {
                    const pEl = document.getElementById(`player-${id}`);
                    const bEl = document.getElementById(`player-${ball.id}`);
                    
                    if (pEl && bEl) {
                        const pRect = pEl.getBoundingClientRect();
                        const bRect = bEl.getBoundingClientRect();
                        
                        // Centros en pixels
                        const pCx = pRect.left + pRect.width/2;
                        const pCy = pRect.top + pRect.height/2;
                        const bCx = bRect.left + bRect.width/2;
                        const bCy = bRect.top + bRect.height/2;
                        
                        const dxPx = bCx - pCx;
                        const dyPx = bCy - pCy;
                        const distPx = Math.sqrt(dxPx*dxPx + dyPx*dyPx);
                        
                        // Radios
                        const pR = pRect.width/2;
                        const bR = bRect.width/2;
                        const minDist = pR + bR; // Distancia de toque exacto
                        
                        // Umbral de activación (Toque + 25px de margen)
                        if (distPx < minDist + 25) {
                            // Calcular offsets lógicos para el snap exacto
                            const fieldRect = fieldContainer.getBoundingClientRect();
                            const theta = Math.atan2(dyPx, dxPx);
                            
                            // Distancia deseada: Toque + 1px
                            const targetDistPx = minDist + 1;
                            
                            const newDxPx = Math.cos(theta) * targetDistPx;
                            const newDyPx = Math.sin(theta) * targetDistPx;
                            
                            // Calcular posición absoluta destino del balón
                            const targetBallVisualX = pCx + newDxPx - fieldRect.left;
                            const targetBallVisualY = pCy + newDyPx - fieldRect.top;
                            
                            const targetBallCoords = calculateCoordinates(targetBallVisualX, targetBallVisualY, fieldRect.width, fieldRect.height);
                            
                            const logicalOffsetX = targetBallCoords.x - player.x;
                            const logicalOffsetY = targetBallCoords.y - player.y;
                            
                            dribbleState = {
                                ballId: ball.id,
                                offsetX: logicalOffsetX,
                                offsetY: logicalOffsetY
                            };
                            
                            // Aplicar Snap Visual Inmediato
                            let snapX = player.x + logicalOffsetX;
                            let snapY = player.y + logicalOffsetY;
                            
                            snapX = Math.max(0, Math.min(100, snapX));
                            snapY = Math.max(0, Math.min(100, snapY));
                            
                            ball.x = snapX;
                            ball.y = snapY;
                            updateDOMPosition(ball.id, snapX, snapY);
                        }
                    }
                }
            }

            if (touchMode) {
                window.addEventListener('touchmove', movePlayerTouch, {passive: false});
                window.addEventListener('touchend', stopMoving);
            } else {
                window.addEventListener('mousemove', movePlayerMouse);
                window.addEventListener('mouseup', stopMoving);
            }
        }

        function movePlayerMouse(e) {
            if (activePlayerId === null) return;
            handleMove(e.clientX, e.clientY);
        }

        function movePlayerTouch(e) {
            if (activePlayerId === null) return;
            e.preventDefault();
            const touch = e.touches[0];
            handleMove(touch.clientX, touch.clientY);
        }

        function calculateCoordinates(visualX, visualY, width, height) {
            let logicalXPercent, logicalYPercent;

            if (state.isVertical) {
                const visualPctX = (visualX / width) * 100;
                const visualPctY = (visualY / height) * 100;

                let containerX = 100 - visualPctY; 
                let containerY = visualPctX;

                if (state.viewMode === 'half') {
                    if (state.activeHalf === 'right') {
                        const logicalUnits = (containerX / 100 * HALF_VIEW_WIDTH) + (FULL_WIDTH - HALF_VIEW_WIDTH);
                        logicalXPercent = (logicalUnits / FULL_WIDTH) * 100;
                    } else {
                        logicalXPercent = containerX / SCALE_RATIO;
                    }
                } else {
                    logicalXPercent = containerX;
                }
                logicalYPercent = containerY;

            } else {
                logicalXPercent = (visualX / width) * 100;
                logicalYPercent = (visualY / height) * 100;
            }
            
            return { x: logicalXPercent, y: logicalYPercent };
        }

        function handleMove(clientX, clientY) {
            const rect = fieldContainer.getBoundingClientRect(); 
            let visualX = clientX - rect.left;
            let visualY = clientY - rect.top;

            const coords = calculateCoordinates(visualX, visualY, rect.width, rect.height);

            // Mover Jugador
            updateDOMPosition(activePlayerId, coords.x, coords.y);

            // Mover Balón
            if (dribbleState) {
                let ballX = coords.x + dribbleState.offsetX;
                let ballY = coords.y + dribbleState.offsetY;
                
                ballX = Math.max(0, Math.min(100, ballX));
                ballY = Math.max(0, Math.min(100, ballY));

                updateDOMPosition(dribbleState.ballId, ballX, ballY);
                dribbleState.lastX = ballX;
                dribbleState.lastY = ballY;
            }
        }

        function stopMoving(e) {
            if (activePlayerId === null) return;

            const el = document.getElementById(`player-${activePlayerId}`);
            if(el) el.classList.remove('is-dragging');

            let clientX = isTouch ? e.changedTouches[0].clientX : e.clientX;
            let clientY = isTouch ? e.changedTouches[0].clientY : e.clientY;

            // Verificar si se soltó fuera
            const fieldRect = fieldContainer.getBoundingClientRect();
            const isInside = (clientX >= fieldRect.left && clientX <= fieldRect.right &&
                              clientY >= fieldRect.top && clientY <= fieldRect.bottom);

            if (!isInside) {
                removePlayer(activePlayerId);
                // Si eliminamos conductor, actualizar balón
                if (dribbleState && typeof dribbleState.lastX !== 'undefined') {
                     const bIndex = state.players.findIndex(p => p.id === dribbleState.ballId);
                     if (bIndex !== -1) {
                         state.players[bIndex].x = dribbleState.lastX;
                         state.players[bIndex].y = dribbleState.lastY;
                         renderOnePlayer(state.players[bIndex]);
                     }
                }
            } else {
                if(el) {
                    const coords = calculateCoordinates(clientX - fieldRect.left, clientY - fieldRect.top, fieldRect.width, fieldRect.height);
                    
                    const pIndex = state.players.findIndex(p => p.id === activePlayerId);
                    if (pIndex !== -1) {
                        state.players[pIndex].x = coords.x;
                        state.players[pIndex].y = coords.y;
                    }
                    
                    if (dribbleState && typeof dribbleState.lastX !== 'undefined') {
                         const bIndex = state.players.findIndex(p => p.id === dribbleState.ballId);
                         if (bIndex !== -1) {
                             state.players[bIndex].x = dribbleState.lastX;
                             state.players[bIndex].y = dribbleState.lastY;
                         }
                    }
                    
                    renderOnePlayer(state.players[pIndex]);
                }
            }

            activePlayerId = null;
            dribbleState = null; 
            isTouch = false;
            
            window.removeEventListener('mousemove', movePlayerMouse);
            window.removeEventListener('mouseup', stopMoving);
            window.removeEventListener('touchmove', movePlayerTouch);
            window.removeEventListener('touchend', stopMoving);
        }

        function saveTactic() {
            const dataToSave = {
                sport: state.sport,
                players: state.players,
                nextId: state.nextId
            };
            localStorage.setItem('tacticalBoardData', JSON.stringify(dataToSave));
            showToast('Táctica guardada');
        }

        function loadTactic() {
            const saved = localStorage.getItem('tacticalBoardData');
            if (saved) {
                const data = JSON.parse(saved);
                state.sport = data.sport;
                state.players = data.players || [];
                state.nextId = data.nextId || 1;
                setSport(state.sport);
                setViewMode('full'); 
                renderPlayers();
                showToast('Táctica cargada');
            } else {
                showToast('No hay datos');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.innerText = msg;
            toast.classList.remove('-translate-y-40', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('-translate-y-40', 'opacity-0');
            }, 3000);
        }

        init();
    </script>
</body>
</html>
